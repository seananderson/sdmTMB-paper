---
title: "sdmTMB: an R package for fast, flexible, and user-friendly generalized linear mixed effects models with spatial and spatiotemporal random fields"
author: "|
  Sean C. Anderson$^1$^[Corresponding author: sean.anderson@dfo-mpo.gc.ca],
  Eric J. Ward$^2$,
  Philina A. English$^1$,
  Lewis A. K. Barnett$^3$\n|
  $^1$Pacific Biological Station, Fisheries and Oceans Canada, Nanaimo, BC, Canada\n|
  $^2$Northwest Fisheries Science Center, National Marine Fisheries Service,\n|
      National Oceanic and Atmospheric Administration, Seattle, WA, USA\n|
  $^3$Alaska Fisheries Science Center, National Marine Fisheries Service,\n|
      National Oceanic and Atmospheric Administration, Seattle, WA, USA\n|
    Running headline: sdmTMB: spatial and spatiotemporal GLMMs\n"
output:
    # bookdown::word_document2:
    bookdown::pdf_document2:
      toc: false
      number_sections: false
      fig_caption: true
      highlight: "monochrome"
csl: mee.csl
bibliography: refs.bib
link-citations: yes
header-includes:
  \usepackage{setspace}\onehalfspacing
  \usepackage[left]{lineno}
  \usepackage{bm}
  \usepackage{amssymb}
  \usepackage{tablefootnote}
  \linenumbers
  \newcommand{\beginsupplement}{
  \setcounter{equation}{0}
  \renewcommand{\theequation}{S.\arabic{equation}}
  \setcounter{table}{0}
  \renewcommand{\thetable}{S\arabic{table}}
  \setcounter{figure}{0}
  \renewcommand{\thefigure}{S\arabic{figure}}}
  \usepackage{lscape}
  \widowpenalty10000
  \clubpenalty10000
editor_options:
  markdown:
    wrap: sentence
abstract: |
    | \noindent 1. Geostatistical data---spatially referenced observations related to some continuous spatial phenomenon---are ubiquitous in ecology and can reveal ecological processes and inform management decisions. However, appropriate models to analyze these data, such as generalized linear mixed effects models (GLMMs) with Gaussian random fields, are often computationally intensive and challenging to implement, interpret, and evaluate.
    | 2. Here, we introduce the R package sdmTMB, which implements predictive-process SPDE- (stochastic partial differential equation) based spatial and spatiotemporal models. Estimation is conducted via maximum marginal likelihood with Template Model Builder (TMB) but can be extended to penalized likelihood or Bayesian inference. We describe the statistical model, illustrate the package's use through two case studies, and compare the functionality, speed, and interface to related software.
    | 3. We highlight advantages of using sdmTMB for this class of models: (1) sdmTMB provides a flexible interface familiar to users of `glm()`, lme4, glmmTMB, or mgcv; (2) estimation is often faster than alternatives; (3) sdmTMB provides simple out-of-sample cross validation; (4) non-stationary processes (time-varying and  spatially varying coefficients) are easily constructed with a formula interface; and (5) sdmTMB includes features not available as a combination in related packages (e.g., penalized smoothers and break-point effects, anisotropy, abundance index standardization).
    | 4. We hope that sdmTMB's user-friendly interface will open this useful class of models to a wider audience within species distribution modelling and beyond.
    | Keywords:
      Gaussian Markov random fields (GMRF),
      generalized linear mixed effects models (GLMM),
      INLA,
      SPDE,
      species distribution modelling,
      R package,
      spatio-temporal or spatial-temporal,
      Template Model Builder
---

<!-- Point 1: set the context for and purpose of the work; -->
<!-- Point 2: indicate the approach and methods; -->
<!-- Point 3: outline the main results; -->
<!-- Point 4: identify the conclusions and the wider implications. -->

<!-- TODO: emphasize the niche carved out: a fast, flexible, easy-to-use, predictive-process univariate spatial or spatiotemporal GLMM, scales from maximum likelihood to penalized likelihood to full Bayesian inference-->

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```
<!-- sdmTMB: spatial and spatiotemporal random field generalized linear mixed-effects models in R in a fast, flexible, and user-friendly interface -->

# Introduction

Ecological data are often collected in space or in space repeatedly over time.
While such data are a rich source of information about ecological processes [@legendre1989a; @rossi1992; @tilman1997spatial], they are challenging to properly model---data closer in space and time are usually more similar to each other than data farther apart due to measured and unmeasured variables [@cressie1993; @diggle2007; @cressie2011].
While measured variables can be accounted for with predictors in a model (e.g., measuring and modelling temperature effects on species abundance), unmeasured variables (e.g., everything influencing species abundance but not explicitly modelled) can cause residual spatial correlation.
Accounting for this residual correlation is important because doing so allows for valid statistical inference [@legendre1989a; @dormann2007], can improve predictions  [e.g., @shelton2014], and can be of ecological interest itself by, for example, identifying locations with similar population responses [e.g., @thorson2019d; @barnett2021].
<!-- LB: seems like we needed some explicit example of why it would be of ecological interest itself to those who are unfamiliar, so I added allusion to local trends...but maybe also mentioning quantification of patchiness or something similar?. More generally, it might be good to expand on the utility of such models for applied ecology, if we can find room within the tight word limit? -->

Geostatistical GLMMs (generalized linear mixed effects models) with spatially correlated random effects are a class of models appropriate for these data [@rue2005gmrf; @diggle2007; @cressie2011].
Similarly to how random intercepts can account for correlation among groups, spatial or spatiotemporal random effects can account for unmeasured variables causing observations to be correlated in space or space and time.
A common approach to modelling these spatial effects is with Gaussian random fields (GRFs), where the random effects describing the spatial patterning are assumed to be drawn from a multivariate normal (MVN) distribution, constrained by some covariance function such as the exponential or Matérn [@cressie1993; @diggle2007; @chiles1999].

Such models quickly become computationally limiting due to the need to invert large matrices to keep track of covariation among data [e.g., @rue2005gmrf; @latimer2009].
Many solutions have been proposed, such as predictive processes [@banerjee2008; @latimer2009], the stochastic partial differential equation (SPDE) approximation to GRFs [@lindgren2011], and nearest-neighbour Gaussian processes [@datta2016; @finley2021].
These approaches reduce the scale of the covariance estimation problem while providing a means to evaluate the data likelihood, thereby allowing fitting via Bayesian [@gelfand2017] or maximum likelihood methods.
This can greatly improve computational efficiency [e.g., @heaton2019].
The SPDE approach is a solution popularized via the INLA R package [@rue2009; @lindgren2011; @lindgren2015] and an implementation in TMB [Template Model Builder, @kristensen2016] that partially relies on INLA to create input matrices [e.g., @osgood-zimmerman2021].
Details are beyond the scope of this paper and are not necessary to use the software discussed here, but the idea is that the solution to a specific SPDE is a GRF with a Matérn covariance function and this 'trick' enables one to efficiently fit approximations to GRFs to large spatial datasets [@lindgren2011].

Systems for specifying statistical models that can include the SPDE, such as INLA and TMB, are flexible and powerful but are challenging to use for many applied ecologists.
For example, TMB requires the user to program in a C++ template and it can be slow to experiment with multiple models when writing bespoke model code.
Packages such as lme4 [@bates2015] and glmmTMB [@brooks2017] let users quickly iterate and explore statistical models---focusing on evaluating fit and comparing models---but do not have built-in SPDE functionality.
Packages such as VAST [@thorson2019] and inlabru [@bachl2019] are powerful user interfaces to fit spatial models that use the SPDE, but they either lack a modular interface familiar to those who have used lme4 or glmmTMB, or lack some functionality.
We provide a more detailed comparison of related software packages in Table 1 and the Discussion.

Here, we introduce the R package sdmTMB, which implements geostatistical spatial and spatiotemporal GLMMs using TMB for model fitting and INLA to set up SPDE matrices.
Our aim is not to replace the above-mentioned statistical packages, but to provide a fast, flexible, and user-friendly interface that is familiar to users of lme4, glmmTMB, or mgcv [@wood2017a], for a specific class of spatial and spatiotemporal models.
One common application is for species distribution models (SDMs), hence the package name.
This paper describes the basic functionality of this R package and its underlying statistical model, illustrates its use through two case studies, and concludes with a comparison to related software.

<!-- millard1985: Space–Time Correlation and Its Effects on Methods for Detecting Aquatic Ecological Change "In practice, spatial correlation is more likely to be a problem than is temporal correlation, given typical monitoring frequencies." -->

<!-- legendre1989a: "Spatial pattern and ecological analysis": "We can expect the spatial approach to ecological problems to bring about a quantum jump for ecologists and population geneticists who had learned a type of statistics where one had to hide space or time structures. It is now possible to use these structures and to integrate them into our analyses as fully-fledged controlled variables." -->

# Model description

sdmTMB fits GLMMs to spatial or spatiotemporal geostatistical data.
Geostatistical data simply refers to data observed at specific spatial coordinates reflecting some underlying spatial process [@rossi1992; @diggle2007].
These data can be collected across discrete points in time.
Areal data (data aggregated to polygon or grid level) may be analyzed using other spatial models, including conditional (CAR) autoregressive models [e.g., @verhoef2018].
sdmTMB can also fit models with areal data if each polygon has an associated centroid.
A benefit of the geostatistical approach over CAR or similar models is that the parameters describing spatial covariance can be more easily interpreted [@wall2004].
<!-- (e.g., spatial variance and range---the distance at which points are effectively independent). -->

The process component of an sdmTMB model can be formed by any combination of main ("fixed") effects, spatial intercept random fields, spatiotemporal intercept random fields, IID (independent and identically distributed) random intercepts (but not currently random slopes), time-varying effects, and spatially varying effects (Fig. \@ref(fig:diagram), Appendix 1).
This process component is combined with an observation error family (e.g., Gaussian, Gamma, binomial, Tweedie) and link (e.g., identity, log, logit) as in any generalized linear model (GLM) [@mccullagh1989].


<!-- Using the notation of a bold capital letter to represent a data matrix or vector, a bold lowercase greek letter to represent a parameter vector, the index $\bm{s}$ to represent a point in space, and the index $t$ to represent a point in time, -->
<!-- the general form of a GLMM is -->
<!-- $g(\bm{\mu}) = \bm{X \beta} + \bm{Z \psi}$, -->
<!-- with the inverse link function $g(x)$ relating the mean $\bm{\mu}$ to fixed-effect predictors in the design matrix $\bm{X}$ with estimated coefficients $\bm{\beta}$ and random effects with the design matrix $\bm{Z}$ with estimated coefficients $\bm{\psi}$. -->
<!-- We can partition the random effects $\bm{Z \psi}$ into subcomponents, each of which can optionally be included in the model (Appendix TODO). -->
<!-- Although, in practice it is rare to include all of these components, the full sdmTMB model is -->
<!-- $$ -->
<!-- g(\mu_{\bm{s},t}) = -->
<!-- \bm{X}_{1,\bm{s},t} \bm{\beta} + -->
<!-- \bm{\alpha}_g + -->
<!-- \bm{X}_{2,\bm{s},t} \gamma_t + -->
<!-- \bm{X}_{3,t} \zeta_{\bm{s}} + -->
<!-- \omega_{\bm{s}} + -->
<!-- \epsilon_{\bm{s},t}, -->
<!-- $$ -->
<!-- where -->

<!-- * $\bm{X}_{1,\bm{s},t}$, $\bm{X}_{2,\bm{s},t}$, and $\bm{X}_{3,\bm{s},t}$ represent design matrices; -->
<!-- * $\bm{\beta}$ represents a vector of fixed-effect coefficients; -->
<!-- * $\alpha_{g}$ represents random intercepts by group $g$, $\alpha_{g}\sim \mathrm{N}(0,\sigma^2_\alpha)$; -->
<!-- * $\gamma_{t}$ represents time-varying coefficients (a random walk), $\gamma_{t} \sim \mathrm{N}(\gamma_{t-1},\sigma^2_\gamma)$; -->
<!-- * $\zeta_{\bm{s}}$ represents spatially varying coefficients (a random field), $\zeta_{\bm{s}} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_\zeta)$; -->
<!-- * $\omega_{\bm{s}}$ represents a random spatial component (a random field), $\omega_{\bm{s}} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_\omega)$; and -->
<!-- * $\epsilon_{\bm{s},t}$ represents a spatiotemporal component (a random field). For the IID case, $\epsilon_{\bm{s},t} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_{\epsilon})$ (Appendix TODO). -->

The GLMMs underpinning sdmTMB models are spatially explicit---they estimate interpretable parameters of a spatial covariance function: parameters defining the magnitude of spatial variation and the rate of correlation decay with distance.
In contrast, semi- and non-parametric approaches do not estimate spatial covariance functions (e.g., randomForest [@liaw2002], MaxEnt [@phillips2006], and most smooths in mgcv [@wood2017a]).
The random fields in sdmTMB are structured as MVN constrained by a Matérn covariance function [@matern1960].
The Matérn can accommodate a range of shapes and can be both isotropic (covariance decays the same in all directions) or anisotropic (covariance in the latitudinal direction may differ from the longitudinal direction) [@haskard2007].
The Matérn standard deviations are estimated separately for the various fields and the range---the distance at which spatial correlation decays to $\sim 0.13$ [@lindgren2015]---can be shared or estimated separately (`share_range` argument).


(ref:diagram-fig) Components of an sdmTMB model with illustrations, descriptions, examples, notation, and example code.
An sdmTMB model can be built from any combination of the process components (first six rows) plus an observation component (last row).
The examples are from an SDM context, but the model can be fit to any spatially referenced point data.
Notation:
We refer to design matrices as $\bm{X}$.
The indexes $\bm{s}$, $t$, and $g$ index spatial coordinates, time, and group, respectively.
The $\sigma$ and $\bm{\Sigma}$ symbols represent standard deviations and covariance matrices, respectively.
All other symbols refer to the  described model components (e.g., $\bm{\beta}$ and $\bm{\omega}$ refer to a vector of main effects and spatial random field deviations, respectively).
See Appendix 1 for a full description of the model.
Note that `s()` denotes a smoother as in mgcv [@wood2017a], `breakpt()` denotes a breakpoint 'hockey-stick' shape [e.g., @barrowman2000], `(1|g) ` denotes a random intercept by group `g`, and `~ 0` is used in an R formula to omit an intercept.

\begin{landscape}

```{r diagram, fig.cap="(ref:diagram-fig)", out.width="9in"}
dir.create("figs", showWarnings = FALSE)
f <- here::here("figs", "diagram.pdf")
knitr::include_graphics(f)
```

\end{landscape}

By default, if spatiotemporal fields are included, they are assumed IID; however, additional options allow them to be modelled as a random walk or first-order autoregressive, AR(1), process (Fig.\ \@ref(fig:diagram); Appendix 1).
Turning off both spatial and spatiotemporal effects allows comparison with a standard non-spatial GLM or GLMM.
We include additional flexibility in specifying the linear fixed effect matrix: covariates can be modelled as penalized smooth functions (generalized additive models, GAMs) using the same `s()` syntax as in mgcv [@wood2017a] (thereby allowing automatic selection of smoother 'wiggliness'), or can be modelled with threshold shapes; for example, hockey-stick models, `breakpt()`, [@barrowman2000] or logistic functions, `logistic()` (Appendix 1).
The smoothers in sdmTMB can mimic most `mgcv::s()` smoothers including bivarate smoothers (`s(x, y)`), smoothers varying by continuous or categorical variables (`s(x1, by = x2)`), cyclical smoothers `s(x, bs = "cc")`, and smoothers with specified basis dimensions `s(x, k = 4)` [@wood2017a].

The sdmTMB model is fit by maximum marginal likelihood.
Internally, a TMB [@kristensen2016] model template is used to calculate the marginal log likelihood and its gradient, and the negative log likelihood is minimized via the non-linear optimization routine `stats::nlminb()` in R [@gay1990; @r2021].
Random effects are estimated at values that maximize the log likelihood conditional on the estimated fixed effects and are integrated over via the Laplace approximation [@kristensen2016].
After rapid model exploration with maximum likelihood, one can optionally pass an sdmTMB model to the R package tmbstan [@monnahan2018] to estimate the joint posterior distribution for Bayesian inference.

sdmTMB models can include penalized likelihoods by assigning priors to model parameters (`?sdmTMBpriors`).
These priors may be useful in cases where estimation is difficult because of identifiability issues or relatively flat likelihood surfaces, or to impart prior information or achieve regularization.
Following other recent SPDE implementations in TMB [@breivik2021; @osgood-zimmerman2021], penalized complexity (PC) priors [@simpson2017; @fuglstad2019] (`?pc_matern`) can constrain the spatial range and variance parameters.

The results from an sdmTMB model can be used to generate various quantities of interest.
For example, sdmTMB provides functionality for generating population-level summaries for each time slice including the center of gravity  [`get_cog()`; e.g., @thorson2016cog] and total population index (`get_index()`) given a user-supplied grid.

# Introductory example using fish survey data

An sdmTMB model requires a data frame that contains a response column, columns for any predictors, and columns for spatial coordinates.
It usually makes sense to convert the spatial coordinates to an equidistant projection such as the Universal Transverse Mercator (UTM) to ensure that distance remains constant throughout the study region [e.g., using `sf::st_transform()`, @pebesma2018].
<!-- TODO: Since this is not particular to your package, maybe the e.g. for how to do this should be moved to the appendix? I do explain the transformation for the owl data and added a sentence to the pcod appendix, but maybe still important to include here as well? -->
Here, we illustrate a spatial model fit to Pacific cod (*Gadus macrocephalus*) trawl survey data from Queen Charlotte Sound, British Columbia, Canada.
Our model contains a main effect of depth as a penalized smoother, a spatial random field, and Tweedie observation error.
Our data frame `pcod` (built into the package) has a column `year` for the year of the survey, `density` for biomass density of Pacific cod in the area swept for a given survey tow, `depth` for depth in meters of that tow, and spatial coordinates `X` and `Y`, which are UTM coordinates in kilometres.

```{r, include=FALSE}
# simplify for paper
# pcod <- dplyr::select(sdmTMB::pcod, year, density, depth, X, Y)
```

```{r, echo=TRUE, eval=FALSE}
library(sdmTMB)
head(pcod)
```

```{}
#>    year density depth     X     Y
#>   <int>   <dbl> <dbl> <dbl> <dbl>
#> 1  2003   113.    201  446. 5793.
#> 2  2003    41.7   212  446. 5800.
#> 3  2003     0     220  449. 5802.
```

We start by creating a mesh object that contains matrices to apply the SPDE approach.

```{r, echo=TRUE, eval=FALSE}
mesh <- make_mesh(pcod, xy_cols = c("X", "Y"), cutoff = 10)
```

Here, `cutoff` defines the minimum allowed distance between mesh vertices in the units of `X` and `Y`.
Alternatively, we could have created any mesh via the INLA package and supplied it to `make_mesh()`.
We can inspect our mesh object with the associated plotting method (`plot(mesh)`; see Fig. \@ref(fig:pcod-fig)A).

We can then fit a model with spatial random fields (`spatial = "on"`) via the function `sdmTMB()`.
We use a penalized smoother for depth as a main effect via `s()` from the mgcv package.
We specify the family as Tweedie to account for positive continuous density values that also contain zeros.
<!-- We could instead model catch weight as the response with an offset for log(area). -->

```{r pcod-eg1-fit, warning=FALSE, message=FALSE, echo=TRUE, eval=FALSE}
fit <- sdmTMB(
  density ~ s(depth),
  data = pcod,
  family = tweedie(link = "log"),
  mesh = mesh,
  spatial = "on"
)
```

<!-- Setting `silent = FALSE` would indicate optimization progress, which is helpful for larger models. -->
We can get a summary of the fit with the `print()` or `summary()` methods or extract parameter estimates as a data frame with the `tidy()` method.
<!-- (omitted for space). -->

```{r,eval=FALSE, echo=TRUE}
summary(fit)
```

```{}
#> Spatial model fit by ML ['sdmTMB']
#> Formula: density ~ s(depth)
#> Mesh: mesh
#> Data: pcod
#> Family: tweedie(link = 'log')
#>             coef.est coef.se
#> (Intercept)     2.37    0.21
#> sdepth          6.17   25.17
#>
#> Smooth terms:
#>            Std. Dev.
#> sds(depth)     13.93
#>
#> Dispersion parameter: 12.69
#> Tweedie p: 1.58
#> Matern range: 16.39
#> Spatial SD: 1.86
#> ML criterion at convergence: 6402.136
```

The output indicates our model was fit by maximum (marginal) likelihood (`ML`).
We also see the formula, mesh, fitted data, and family.
Next we see any estimated main effects including the linear component of the smoother (`sdepth`), the standard deviation on the smoother weights (`sds(depth)`), the Tweedie dispersion and power parameters, the Matérn range distance, the marginal spatial field standard deviation, and the negative log likelihood at convergence.

We can make predictions with the `predict()` method (`?predict.sdmTMB`) and optionally use the `newdata` argument to predict on a new data frame with any locations and values for the predictor columns.
Here, we will predict on a 2x2 km grid (`qcs_grid`) that covers the entire region of interest so we can visualize the predictions spatially (or calculate a standardized population index with a spatiotemporal model).
The grid contains spatial covariate columns and all predictors used in the model set at values for which we want to predict.

```{r, echo=TRUE, eval=FALSE}
p <- predict(fit, newdata = qcs_grid)
```

The output of `predict()` is a data frame containing overall estimates in link space, estimates from the non-random-field components (intercept and depth), and estimates from the random field components.
We show a basic plot of the estimated spatial random field, predictions across a depth gradient, and predictions in space in Fig. \@ref(fig:pcod-fig)B--D.

We could extend this spatial model to be a spatiotemporal one simply by supplying the year column name to the `time` argument and specifying how we want the spatiotemporal random fields to be structured.
Here we will keep the spatial field and structure the spatiotemporal random fields as AR(1).

```{r fit-tv, eval=FALSE, echo=TRUE}
fit_spatiotemporal <- sdmTMB(
  density ~ s(depth), family = tweedie(link = "log"), data = pcod, mesh = mesh,
  time = "year", spatial = "on", spatiotemporal = "ar1"
)
```

We could generate an area-weighted population index (e.g., a relative or absolute index of abundance or biomass) that is independent of sampling locations by predicting from that fit on a grid covering the area of interest and summing the predicted biomass with the `get_index()` function (Fig. \@ref(fig:pcod-fig)E, Appendix 2).

(ref:pcod-fig-cap) Output from the Pacific cod spatial model example in Queen Charlotte Sound, BC, Canada.
(A) SPDE mesh (lines) combined with the trawl survey observations (points).
Finer meshes will be slower to fit but generally increase the accuracy of the SPDE approximation.
The circle area corresponds to biomass density of Pacific cod caught on individual trawls.
(B) Spatial random field:
these values are shown in link (log) space and represent spatially correlated deviations that are not accounted for by the depth effect.
(C) Overall prediction: these estimates represent the combination of all fixed and random effects. Crosses illustrate center of gravity (`get_cog()`) from a spatiotemporal version; lighter crosses are more recent.
(D) Conditional effect of depth modelled as a penalized smoother. These predictions are made omitting the spatial random field.
(E) Standardized area-weighted population index derived from a spatiotemporal version (`get_index()`). The line represents the estimate and the ribbon indicates a 95\% confidence interval (+/- 2 SEs).
<!-- LB: I wasn't sure which panel the statement about omitting the spatial random field applied to, but moved things around. -->

```{r pcod-fig, fig.cap="(ref:pcod-fig-cap)", out.width="5.2in", fig.align='center'}
pcodfig <- here::here("figs", "pcod-fig.pdf")
knitr::include_graphics(pcodfig)
```

# Example of a spatially varying coefficient with citizen science data
<!-- # Estimate a spatially varying effect from citizen science data -->

Snowy Owls (*Bubo scandiacus*) breed on the arctic tundra and are irruptive migrants, meaning that they appear across the mid-latitudes of North America in much greater numbers in some winters than others.
The reasons for this interannual variation in the number of individuals migrating south are not well understood but seem to be related to high abundances of food during the breeding season and therefore sharp increases in breeding ground population densities [@robillard2016].
The North Atlantic Oscillation Index (NAO) has been linked to productivity of both owls and their prey in Europe [@millon2014].
Because both productivity and the choice of wintering location could be influenced by climate, we tested for a spatially varying effect of annual mean NAO index on winter abundance across the southern boundary of their winter distribution.
We fit counts observed in North America during annual Christmas Bird Counts [@cbc] using a negative binomial (NB2) distribution, random intercepts for year, spatial and spatiotemporal random fields, and a spatially varying coefficient associated with the NAO.

```{r owl-fit, warning=FALSE, message=FALSE, cache=TRUE, echo=TRUE, eval=FALSE}
mesh <- make_mesh(snow, xy_cols = c("X", "Y"), cutoff = 1.5)
fit_owls <- sdmTMB(
  count ~ 1 + nao + (1 | year_factor),
  spatial_varying = ~ 0 + nao,
  family = nbinom2(link = "log"), data = snow, mesh = mesh,
  time = "year", spatial = "on", spatiotemporal = "iid"
)
```

We found a weak average positive effect of annual mean NAO on overall counts, but a southeast to northwest gradient in the intensity of the effect (Fig. \@ref(fig:owl-nao), Appendix 3).
This result is consistent with owls closest to the Atlantic coast and those migrating the furthest south being the most affected by NAO.

(ref:owl-nao-fig) Spatially varying coefficient for effect of mean annual NAO (North Atlantic Oscillation) on counts of Snowy Owls observed on annual Christmas Bird Counts 1979--2020 in Canada and the US.
Points represent all count locations and circle area is scaled to the mean number of owls observed per year (range: 0 to 8).
The effect is multiplicative on owl count per NAO unit.

```{r owl-nao, fig.cap="(ref:owl-nao-fig)", out.width="4.1in", fig.align='center'}
owl <- here::here("figs", "owl-nao-effect.png")
knitr::include_graphics(owl)
```

# Model validation and selection

Validation and selection of state-space models is challenging, particularly when using the Laplace approximation [@thygesen2017a].
We provide several approaches to assist this process:
(1) The Akaike Information Criterion [AIC, @akaike1974] can be calculated with `AIC()`, although AIC has well-documented biases with mixed-effects models [@liang2008].
(2) Alternatively, k-fold cross validation with `sdmTMB_cv()` can be used with user-specified or randomly chosen folds for model selection [e.g., via expected log predictive density [ELPD], @vehtari2017] or to evaluate goodness of fit according to user-calculated criteria (e.g., mean squared error, area under the curve).
(3) An sdmTMB model can be passed to the tmbstan package [@monnahan2018] to sample from the joint posterior with Stan [@carpenter2017], evaluate the accuracy of the Laplace approximation, or evaluate residuals (see `?extract_mcmc`).
(4) The `residuals()` method returns randomized quantile [@dunn1996] or probability integral transform (PIT) [@smith1985] residuals.
<!-- These residuals, however, are calculated as $\hat{y} - y$ where $\hat{y}$ is the sum of the fixed effect estimates and the random effect values that maximize the likelihood conditional on the estimated fixed effects.  -->
For state-space models, these residuals have known statistical issues [@thygesen2017a] but are quick to calculate.
Simulation-based residuals [@dharma] (`dharma_residuals()`), one-step-ahead residuals [@thygesen2017a], or residuals from a single MCMC draw [e.g., @rufener2021] are also possible, but are slower.
(5) The `simulate.sdmTMB()` method can simulate from fitted models and the `sdmTMB_simulate()` function can simulate entirely new data to which models can be fit to ensure identifiability, evaluate bias and precision in parameter estimation, or evaluate the consequences of model misspecification.
<!-- Simulations can also be passed to the R package DHARMa [@DHARMa] to calculate simulation-based residual diagnostics (APPENDIX OR VIGNETTE). -->

<!-- We could generate a standardized index from that fit on a 2x2 km grid by supplying the `area` per grid cell and telling `predict.sdmTMB()` to return a necessary TMB object (Fig. \@ref(fig:pcod-fig)E). `get_index()` sums the biomass across grid cells to derive an area-weighted index of biomass independent of sampling locations. -->

```{r, eval=FALSE, echo=FALSE}
p <- predict(fit_spatiotemporal, newdata = qcs_grid, area = 4, return_tmb_object = TRUE)
ind <- get_index(p)
```


# Package comparisons

There are many R packages capable of fitting geostatistical spatial or spatiotemporal models [e.g., @heaton2019].
sdmTMB, VAST, INLA/inlabru, and spaMM [@rousset2014] are the most closely related, as they all provide a user interface to SPDE-based GRF models; we also include spBayes in our software comparison as it is a prominent package that can fit related predictive-process models without the SPDE (Table 1).
sdmTMB, VAST, and mgcv can estimate anisotropic covariance whereas INLA/inlabru and spBayes are currently limited to isotropic covariance.
sdmTMB and mgcv focus on univariate response data, whereas VAST, INLA/inlabru, spaMM, and spBayes extend to multivariate responses with varying limitations.
To our knowledge, VAST is the only package to implement spatial [@thorson2015] and spatial dynamic factor analysis [@thorson2016] and spatial empirical orthogonal function (EOF) regression [@thorson2020].
<!-- However, VAST is typically less effective at replicating nonlinear preferences than GAMs, which are supported by several of these packages [@brodie2020]. -->
Of these packages, only sdmTMB and inlabru can currently fit threshold (e.g., hockey-stick) covariate relationships.
spaMM is limited to a spatial random field and spBayes implements spatiotemporal fields, but only as a random walk.
There is considerable variability in the available observation likelihoods across packages (Table 1).
We provide comparisons of the syntax and the reproducibility of results from models fit using INLA or inlabru (Appendix 4) and VAST (Appendix 5).


```{r compare-table}
library(kableExtra)
suppressMessages(suppressWarnings(d <- readr::read_csv(here::here("doc/software-comparison.csv"), show_col_types = FALSE, comment = "#")))
d <- as.matrix(d)
# d[d == "1"] <- "\\checkmark"
d <- gsub("^1", "\\\\checkmark", d)
# d[d == "1*"] <- "\\checkmark\\footnote{a}"
# d[d == "GAMs*"] <- "GAMs\\footnote{a}"
# d[d == "0"] <- "--"
d <- gsub("^0", "--", d)
# d[d == "0*"] <- "--\\footnote{a}"
d <- as.data.frame(d)
names(d)[1] <- ""
row.names(d) <- NULL
d <- d[,c(1, 2, 3, 5, 6, 4, 7, 8, 9)]
d$Hmsc <- NULL

d$INLA <- NULL
names(d)[names(d) == "inlabru"] <- "INLA/inlabru"

knitr::kable(d, format = "latex", caption = "Comparison of functionality between several R packages that can fit geostatistical GLMMs.",
  booktabs = TRUE,
  linesep = c(
    rep('', 4), # coefs
    '\\addlinespace',
    rep('', 6), # correlation stuff
    '\\addlinespace',
    rep('', 12), # likelihood
    '\\addlinespace',
    rep('', 2), # bayes
    '\\addlinespace'
  ),
  escape = FALSE, row.names = FALSE) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::footnote(
    general = paste(
      "$^1$Technically possible but non-trivial.",
      "$^2$Penalized smoother GAMs that determine `wiggliness'.",
      "$^3$inlabru but not INLA.",
      "$^4$Spatiotemporal fields as random walk only.",
      "$^5$SPDE approach as in Miller et al. (2019).",
      "$^6$Does have predictive process knots.",
      "$^7$Zero-inflated NB2 only.",
      "$^8$Tweedie power parameter fixed for \\\\texttt{mgcv::gamm()}.",
      "$^9$Possible as log-linked Poisson GLMM with aggregated data.",
      "$^{10}$Hurdle models possible by fitting components separately."
    ),
    escape = FALSE, threeparttable = TRUE
  )
```

<!-- TODO: Line 242. Can sdmTMB be run in parallel? If so, does the parallelism share memory across the cores or does the memory grow with the number of cores? This is a HUGE feature of PARDISO within INLA/inlabru allowing for very large models to be fit on HPCs. It might be worth mentioning and adding to Table 1. Also Line 242: do you expect the same relative performance between the software packages as more cores are used? -->

We ran a simple speed comparison between sdmTMB, inlabru, and mgcv for fitting an SPDE spatial random field model to 1000 data points with Gaussian error across a range of mesh resolutions (Fig. \@ref(fig:timing), Appendix 6).
In this test, for mesh resolutions under 500 nodes, sdmTMB was faster than inlabru or mgcv.
inlabru was the least affected by mesh resolution and beyond 500 nodes was faster than sdmTMB with default sdmTMB settings.
mgcv was slightly slower than sdmTMB and was more affected by mesh resolution.
With the random effect normalizing constant calculated in R (`control = sdmTMBcontrol(normalize = TRUE)`), sdmTMB was the fastest across all mesh resolutions (this option may not be possible or as fast for all models).
<!-- Results with up to an order of magnitude more data slightly shifted the lines up without affecting the qualitative pattern (not shown). -->
<!-- TODO:  Too wordy and informal by describing ‘the lines’. Needs rewording as a discussion about the runtimes. -->
Our test was restricted to one core and default R algebra libraries; all packages could run faster with optimized libraries and parallel processing.
Results with optimized math libraries (openBLAS: @penblas2021 and PARDISO: @pardiso-7.2c) resulted in a ~10% speed increase for sdmTMB and inlabru and a ~7--9-fold speed increase for mgcv.
<!-- Note two other references for PARDISO were listed as required here https://pardiso-project.org/manual/manual.pdf -->
<!-- LB: also worth noting which packages do/do not have parallel infrastructure (notably that VAST does not) -->


(ref:timing-fig) Comparison of time to fit an SPDE spatial random field model with 1000 observations, an intercept and one predictor, Gaussian error, and a sequence of SPDE resolutions.
Lines represent means and ribbons ranges across 20 random iterations.
Note the log x and y axes.
sdmTMB used the default settings and `normalize = TRUE`, which calculates the random effect normalizing constant in R.
VAST is similar to sdmTMB and so is not shown.
inlabru used the empirical Bayes integration strategy and Gaussian approximation with `bru_max_iter = 1`, and the `like()` formulation.
mgcv used `bam()`, `method = "fREML"`, and discretized covariates [@miller2019].
<!-- inlabru/INLA could be faster with the PARDISO sparse linear solver and TMB could be faster with an optimized BLAS library. -->
<!-- All platforms were restricted to one core and could be faster with parallel computation. -->
<!-- https://www.sciencedirect.com/science/article/abs/pii/S0167739X00000765 -->

```{r timing, fig.cap="(ref:timing-fig)", out.width="3.5in", fig.align='center'}
f <- here::here("figs", "timing-spatial.pdf")
knitr::include_graphics(f)
```

# Discussion

How does one choose among the related packages mentioned in this paper to fit SPDE-based geostatistical GLMMs?
Assuming a given package can fit the model of interest (Table 1), we suggest the primary differences are the user interface and speed.
We think users familiar with `stats::glm()`, lme4, or glmmTMB will find sdmTMB most approachable.
Users familiar with INLA will find inlabru approachable.
Users familiar with mgcv can adapt mgcv to fit similar models with custom code [@miller2019] and INLA/inlabru and mgcv are also general purpose modelling packages.
VAST is the sole option for fitting some multivariate models;
alternatively, because VAST focuses on multivariate delta models and fisheries applications (Appendix 5), users fitting "simple" univariate spatial/spatiotemporal GLMMs may find sdmTMB more straightforward to use.
Users looking for calculation, with uncertainty, of derived variables such as area-weighted population indexes, may favour sdmTMB or VAST (although such quantities can be post hoc derived with other packages).
Speed-wise, sdmTMB (and VAST) may be fastest in some cases (e.g., random effect normalization) or in situations up to mid-resolution meshes (~500 knots), which in practice can cover fairly complex spatial processes on large datasets [e.g., @anderson2019b; @maureaud2021; @english2022].
INLA/inlabru, or spaMM for spatial models, scale the best with very high-resolution meshes.

<!-- However, with the SPDE, mgcv is typically slower than sdmTMB for similar models without optimized matrix libraries and lacks certain  -->

<!--
There are many R packages available for fitting spatially explicit models to large datasets and we cannot review them all here [see @heaton2019]; however, the three most closely related are VAST, inlabru, and mgcv (Table 1).
VAST is also built on TMB and, for univariate data, should be able to fit equivalent models with some minor differences in the user interfaces.
Interface-wise, VAST is less modular (e.g., by default constructing meshes before fitting, making predictions at the same time as fitting), is written from a fisheries perspective, and lacks some interface elements that we think make sdmTMB more broadly usable by applied ecologists.
For example, `sdmTMB()` has a `family` argument as in `glm()`, a `predict()` method, and human-readable options for spatial/spatiotemporal fields (e.g., `spatial = 'on'`, `spatiotemporal = 'AR1'`).
From a fisheries perspective, sdmTMB achieves three of the four design principles outlined in @thorson2019 for index standardization: it allows area weighting, can distinguish catchability and habitat covariates (by deciding what is fixed when predicting), and conditions on missing covariates (random fields).
Unlike VAST, however, sdmTMB does not currently extend to multivariate applications or support delta/hurdle models.

inlabru is similar to sdmTMB in design, but differs fundamentally in that fitting is achieved via INLA and approximate Bayesian computation.
For some models, TMB/sdmTMB can be considerably faster than INLA/inlabru, but those differences depend on the SPDE mesh, model, algebra libraries, and fitting algorithm settings [Fig. \@ref(fig:timing), @osgood-zimmerman2021].
One major capability included in sdmTMB but not INLA/inlabru is anisotropy.
Furthermore, we think the sdmTMB interface will be more familiar than inlabru to users of `glm()`, lme4, mgcv, or glmmTMB.
On the other hand, inlabru fits additional model classes including log Gaussian Cox processes and may be particularly usable to those already familiar with INLA.

mgcv can fit many similar models to sdmTMB either with various flavours of splines or even with the SPDE approximation to random fields [@miller2019]; however, there are some notable advantages of sdmTMB for the specific class of models discussed here.
First, the smoothers typically used with mgcv (e.g., thin plate splines), while capable of making equivalent predictions [@miller2019; @pedersen2019], do not offer the ecological interpretability of a spatially explicit random field model (spatial range and variance estimates).
Second, the implementation of the Tweedie distribution in mgcv requires the power parameter to be fixed in a mixed effects model.
Third, mgcv does not have built-in functionality to calculate derived values with uncertainty such as population indexes or center of gravity.
Despite these sdmTMB advantages for the models discussed here, mgcv is an immensely powerful modelling package that extends well beyond spatial random field models.
-->

<!-- MVT? time-varying epsilon, non-gaussian fields -->
<!-- 3d models, continuous time, -->

Additional functionality in sdmTMB not already mentioned includes interpolating across missing time slices and forecasting, the barrier SPDE model of @bakka2019, time-varying spatiotemporal covariance parameters, and simulation from the parameter joint precision matrix.
Future development may include zero-inflated models, improvements to Bayesian sampling efficiency [e.g., @monnahan2021], continuous time models [e.g., @blangiardo2015book], and non-Gaussian random fields [e.g., @anderson2019].
The included TMB `.cpp` file also provides a high-quality and tested model template that can be modified to add additional features.
<!-- Not sure what kind of refs you want here?  INLA's non-gaussian random fields are mentioned here @bakka2018review-->
<!-- sdmTMB does not currently include  -->
<!-- We may introduce explicit delta models, but many such models can already be fit with sdmTMB by modelling the two components separately. -->
<!-- We may introduce capability for multivariate response data, but VAST already focuses on such models with a TMB backend. -->
<!-- Furthermore, we would only add this functionality if we could maintain a straightforward interface for univariate data. -->
<!-- Line 275: I would suggest adding a MAJOR benefit of sdmTMB for advanced users: a tool for quickly building high-quality, bug-free, and tested model templates! This is by far my favourite feature of the brms package, as it allows me to build a pretty complex ‘base-model’ in c++/stan code before adding my own custom functionality on top of it. It saves me a bunch of time. If you don’t currently have a ‘return_TMB_code=TRUE’ option, then I would highly recommend it. -->

Spatially and spatiotemporally explicit data are increasingly collected in ecology and have the power to reveal new ecological processes [e.g., @dinnage2020; @english2022] and improve ecological management [@sofaer2019].
These data present statistical challenges to modelling them effectively and efficiently as appropriate models such as GLMMs with random fields are often computationally intensive and challenging to implement, interpret, and evaluate.
We hope the development of user-friendly interfaces such as sdmTMB opens this useful class of models to a wider audience of users.

# Acknowledgements

sdmTMB would not be possible without the TMB [@kristensen2016] and INLA [@rue2009; @lindgren2011; @lindgren2015] R packages.
sdmTMB is heavily inspired by and in some places code has been adapted from both the VAST [@thorson2019] and glmmTMB [@brooks2017] R packages.
Penalized spline support was possible thanks to mgcv [@wood2017a].
We thank the authors of all these packages.
We thank S. Kotwicki, M. Lindmark, C.C. Monnahan, P.M. Regular, J.T. Thorson, and J. Watson for helpful comments that substantially improved the manuscript.

# Conflict of Interest statement

The authors declare no conflict of interest.

# Author Contributions

SA led development of the software and EW contributed key software code.
All authors contributed software code, guided software development, and
participated in testing.
PE led the Snowy Owl case study.
All authors contributed to appendix code.
SA led the writing of the manuscript; all authors contributed critically to the drafts and gave final approval for publication.

# Supporting Information

Appendix 1: sdmTMB statistical model description\
Appendix 2: Example of index standardization of fishery-independent survey data with sdmTMB\
Appendix 3: Example of a spatially varying effect of climate on citizen science count data with sdmTMB\
Appendix 4: Species distribution model comparison between INLA and sdmTMB\
Appendix 5: Comparison of index standardization of survey data with VAST and sdmTMB\
Appendix 6: sdmTMB speed testing methods and model validation description

<!--
All submissions with more than one author must include an Authors’ contributions statement. All persons listed as authors on a paper are expected to meet ALL of the following criteria for authorship:

substantial contributions to conception and design, or acquisition of data, or analysis and interpretation of data, or drafting the article or revising it critically for important intellectual content;
final approval of the version to be published;
agreement to be accountable for the aspects of the work that they conducted and ensuring that questions related to the accuracy or integrity of any part of their work are appropriately investigated and resolved.
Acquisition of funding, provision of facilities, or supervising the research group of authors without additional contribution are not usually sufficient justifications for authorship. The statement should include an explanation of the contribution of each author. We suggest the following format for the Authors’ contributions statement:

AB and CD conceived the ideas and designed methodology; CD and EF collected the data; EF and GH analysed the data; AB and CD led the writing of the manuscript. All authors contributed critically to the drafts and gave final approval for publication. -->

# Data Availability

A development version of sdmTMB is available at <https://github.com/pbs-assess/sdmTMB>.
sdmTMB will be available on CRAN before publication.
Paper source code is available at <https://github.com/seananderson/sdmTMB-paper> and will be archived on Zenodo before publication.

<!--
To enable readers to locate archived data from papers, we require that authors list the database and the respective accession numbers or DOIs for all data from the manuscript that has been made publicly available. For example, “Data available from the Dryad Digital Repository http://dx.doi.org/10.5061/dryad.41qh7 (Kiere & Drummond 2016).” When a DOI is available for the data, the full data citation should also be given in the reference list (see below). For further information see our data archiving policy.
-->

<!--

-   outline the philosophy and how the functions work together

    -   modular
    -   familiar (similar to glm, lme4, glmmTMB, mgcv, etc.)
    -   separate fitting and predicting
    -   avoid expensive calculations unless needed

-   intended audience: ecology, but much broader too

-   self simulation testing --- appendix

-   package comparison fitting --- appendix

-->

# References

::: {#refs}
:::

