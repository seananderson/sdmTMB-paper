---
title: "sdmTMB: Fast, flexible, and user-friendly spatial and spatiotemporal generalized linear mixed-effects models"
author: "|
  Sean C. Anderson$^1$^[Corresponding author: sean.anderson@dfo-mpo.gc.ca], Other authors\n| $^1$Pacific Biological Station Fisheries and Oceans Canada, \n| Nanaimo, BC, Canada\n|
  $^2$Other addresses\n"
output:
    bookdown::pdf_document2:
      toc: false
      number_sections: false
      fig_caption: true
csl: mee.csl
bibliography: refs.bib
link-citations: yes
header-includes:
  \usepackage{setspace}\onehalfspacing
  \usepackage[left]{lineno}
  \usepackage{bm}
  \linenumbers
  \newcommand{\beginsupplement}{
  \setcounter{equation}{0}
  \renewcommand{\theequation}{S.\arabic{equation}}
  \setcounter{table}{0}
  \renewcommand{\thetable}{S\arabic{table}}
  \setcounter{figure}{0}
  \renewcommand{\thefigure}{S\arabic{figure}}}
editor_options:
  markdown:
    wrap: sentence
abstract: |
    | \noindent Point 1: set the context for and purpose of the work; \smallskip
    | Point 2: indicate the approach and methods; \smallskip
    | Point 3: outline the main results; \smallskip
    | Point 4: identify the conclusions and the wider implications. \smallskip
---

```{r, echo = FALSE, include = FALSE, message = FALSE, warning = FALSE}
library(here)
library(ggplot2)
library(dplyr)
library(sdmTMB)
```

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

Ecological data are often collected in space or in space repeatedly over time.
While such data are a rich source of information about ecological processes [@legendre1989a], they are challenging to properly model---data closer in space and time are usually more similar to each other than data farther apart, both due to measured and unmeasured variables [e.g., @cressie1993; @cressie2011].
While measured variables can be accounted for via predictors in a model (e.g., measuring and modelling temperature effects on species abundance), unmeasured variables (e.g., everything influencing species abundance but not explicitly modelled) can cause residual spatial correlation.
This residual correlation is ideally dealt with because doing so (1) results in valid statistical inference [e.g., @legendre1989a], (2) can improve predictions compared to ignoring it [e.g., @shelton2014], and (3) can be of ecological interest itself [e.g., @barnett2021].

Geostatistical GLMMs (generalized linear mixed effects models) with spatially correlated random effects are a class of models appropriate for these data.
Similarly to how random intercepts can account for correlation among groups (e.g., plants counted in plots of land), spatial/spatiotemporal random effects can account for unmeasured variables causing observations to be correlated in space or space and time.
A common approach to modelling such random effects is with Gaussian random fields (GRFs), where the random effects are assumed drawn from a multivariate normal distribution, constrained by some covariance function such as the exponential or Matérn [@cressie1993; @diggle1998; @chiles1999].

While simple on the surface, such models quickly become computationally limiting due to the need to invert large matrices to keep track of covariation among data [e.g., @latimer2009].
Many solutions have been proposed, such as predictive processes [@banerjee2008; @latimer2009], the stochastic partial differential equation (SPDE) approximation to Gaussian Markov random fields (GMRFs) [@lindgren2011], and nearest-neighbour Gaussian processes [@datta2016].
These approaches reduce the scale of the covariance estimation problem while providing a means to evaluate the data likelihood, thereby allowing fitting via Bayesian or maximum likelihood methods.
This can make an enormous difference to computational efficiency [@heaton2017].
The SPDE approach is a solution popularized via the INLA R package [@rue2009; @lindgren2011] and an implementation in TMB [Template Model Builder, @kristensen2016] that partially relies on INLA [e.g., @osgood-zimmerman2021].
Details are beyond the scope of this paper, and are not necessary to use the software discussed here, but the idea is that the solution to a specific SPDE is a GRF with a Matérn covariance function and this 'trick' enables one to efficiently fit GRFs to large spatial datasets [@lindgren2011].

Template systems for specifying statistical models that can include the SPDE, such as INLA and TMB, are flexible and powerful but are challenging to use for many applied ecologists.
It can also be slow to iterate on and experiment with many models when writing bespoke template code.
Packages such as lme4 [@bates2015] and glmmTMB [@brooks2017] let users quickly iterate and explore statistical models---focusing on evaluating fit and comparing models---but do not have built-in SPDE functionality.
Packages such as VAST [@thorson2019] and inlabru [@bachl2019] are powerful user interfaces to spatial models that use the SPDE, but either lack a modular interface familiar to those who have used lme4 or glmmTMB, or lack some of the flexibility for the particular class of models discussed here.
We provide a more detailed comparison of related software packages in Table 1 and the Discussion.
<!-- User interfaces through software such as VAST or inlabru can greatly reduce these challenges. VAST is built on TMB, and is extremely powerful (e.g., fitting many multivariate models not described here), but does not provide a simple, familiar, modular interface for users with basic spatial or spatiotemporal data. inlabru provides a somewhat more familiar interface to a large class of models including GRMF models, but is strictly Bayesian, lacks some flexibility for the particular class of models discussed here. It also relies on INLA, and at least for some problems, TMB can be much faster [@osgood-zimmerman2021]. We provide a more detailed comparison of related software packages in Table 1 and the discussion. -->

<!-- User interfaces to classes of models fit by these template systems can greatly  -->

<!-- reduce these challenges for the vast majority of models. -->

<!-- keep the above even briefer? -->

<!-- inlabru is "very good" but not entirely familiar to those used to `glm()`, lme4, glmmTMB, or mgcv; -->

<!-- *TODO: the differences are many and more than can be listed here. Keep brief add Table or discussion later about differences and when to pick one over the other?* -->

Here, we introduce our R package sdmTMB, which implements spatial and spatiotemporal GLMMs using TMB and INLA.
Our aim is not to replace any of the above-mentioned statistical packages, but to provide a fast, flexible, and user-friendly interface for a specific class of spatial and spatiotemporal models that should be familiar to users of lme4, glmmTMB, or mgcv [@wood2017a].
One common application is for species distribution models (SDMs), hence the package name.
This paper describes the basic functionality of the R package and the underlying statistical model, illustrates its use through X case studies, and concludes with a discussion of additional functionality and related software.


<!-- -   [@anderson2019] -->
<!-- -   [@maureaud2021] -->
<!-- -   [@anderson2020] -->
<!-- -   [@osgood-zimmerman2021] -->
<!-- -   [@breivik2021] -->
<!-- -   [@monnahan2021] -->
<!-- -   [@shelton2014] -->
<!-- -   [@lindgren2011] -->
<!-- -   [@latimer2009] -->

<!-- Packages: -->

<!-- spaMM: @rousset2014 -->
<!-- spNNGP: @finley2021 -->


<!-- millard1985: Space–Time Correlation and Its Effects on Methods for Detecting Aquatic Ecological Change "In practice, spatial correlation is more likely to be a problem than is temporal correlation, given typical monitoring frequencies." -->

<!-- legendre1989a: "Spatial pattern and ecological analysis": "We can expect the spatial approach to ecological problems to bring about a quantum jump for ecologists and population geneticists who had learned a type of statistics where one had to hide space or time structures. It is now possible to use these structures and to integrate them into our analyses as fully-fledged controlled variables." -->

<!-- ecology has a latitude gradient: von Humboldt, A. (1808) Ansichten der Natur mit wissenschaftlichen Erlauterungen. J.G. Cotta, Tübingen, Germany. -->

(ref:diagram-fig) Components of an sdmTMB model with illustrations, descriptions, examples, notation, and example code.
An sdmTMB model can be built from any combination of these components.
The examples are from an SDM context, but the model can be fit to any spatially referenced point data.
Notation:
We refer to design matrices as $\bm{X}$.
The indexes $\bm{s}$, $t$, and $g$ index spatial coordinates, time, and 'group', respectively.
The $\sigma$ and $\bm{\Sigma}$ symbols represent standard deviations and covariance matrices, respectively.
All other symbols refer to the  described model components.
Note that `s()` denotes a smoother as in mgcv [@wood2017a], `breakpt()` denotes a breakpoint 'hockey-stick' shape [e.g., @barrowman2000], `(1|g) ` denotes a random intercept by group `g`, and `~ 0` is used in an R formula to omit an intercept.

```{r diagram, fig.cap="(ref:diagram-fig)"}
if (file.exists(here::here("figs/diagram.pdf"))) {
  knitr::include_graphics(here::here("figs/diagram.pdf"))
} else {
  plot(1, type = "n", main = "figs/diagram.pdf missing; will be synced when complete")
}
```

# Examples of sections:

# Materials and Methods

# Description

Spatial and spatiotemporal models constructed with sdmTMB may be viewed as spatially explicit models, in the sense that they estimate parameters of a user-specified spatial covariance function, and these estimates may be converted into interpretable quantities common in spatial statistics (spatial decay, range).
We contrast these approaches with semi- and non-parametric approaches that do not estimate spatial covariance functions (e.g., randomForest [@liaw2002], MaxEnt [@phillips2006], some smooths in mgcv [@wood2017a]). By default, sdmTMB implements the Matérn covariance function (REF) (cite Rue et al?)---this function can accommodate a range of shapes and can be both isotropic (covariance decays the same in all directions) or anisotropic (covariance in a latitudinal direction may be different than in the longitudinal direction).

- high-level paragraph or two about what the model includes, referencing Fig 1
- high-level paragraph about design philosophy (modular [separate predict, residuals, etc.], familiar/clear naming, expensive computations only if needed, work with regular data frames, ...?)
- high-level paragraph about simulation capabilities and + testing performed (reference supplement)
- model selection/cross validation paragraph
- derived quantities paragraph (or just put this in the examples?)

- example 1 + figs
- example 2 + figs

- discussion
    - take home, re-iterate
    - how to pick among packages/tools including a bit outside the SPDE world? (table)
    - touch on other stuff possible: priors, Bayes, barrier meshes, residuals, 
      simulation from joint precision, ...?

# Model

<!-- Although sdmTMB has been developed with spatial or spatiotemporal modelling as a primary focus, the statistical models it fits fall under the class of GLMMs. -->
<!-- GLMMs are available in several widely used packages, including glmmTMB [@brooks2017], mgcv [@wood2017a], and lme4 [@bates2015], and to allow comparison with these packages, sdmTMB allows for spatial and spatiotemporal effects to be omitted. -->

By default, we assume that if spatiotemporal fields are included, they are independent and identically distributed (IID); however, additional options allow them to be modelled as a random walk or first-order autoregressive, AR(1), process (Fig.\ \@ref(fig:diagram)).
Turning off both spatial and spatiotemporal effects allows comparison with a standard non-spatial GLM or GLMM.
We include additional flexibility in specifying the linear fixed effect matrix: covariates can be modelled as penalized smooth functions (generalized additive models; GAMs) using the same `s()` syntax as in mgcv [@wood2017a], or to be modelled with threshold shapes [e.g., hockey stick models, @barrowman2000] (Fig.\ \@ref(fig:diagram)).

[paragraph about spde and gaussian process / Matern covariance here]

<!-- Paragraph on model selection here-->
Following glmmTMB, we allow AIC to be calculated for each sdmTMB model [@akaike1974]. 
Because of well-documented biases of AIC with mixed-effects models [@liang2008] we also provide functionality to perform estimation via k-fold cross-validation. 
Our function `sdmTMB::sdmTMB_cv()` allows for any number of folds, with assignments being user-specified or chosen randomly. 
The predictive log-density is calculated for each fold and summarized across folds for a total measure of the predictive accuracy of a model. 

<!-- Paragraph on derived quantities here-->
The results from a model fit with sdmTMB can be used to generate quantities of interest.
For example, sdmTMB provides functionality for generating population-level summaries for each time slice including the center of gravity (`sdmTMB::get_cog()`) and total population index (`sdmTMB::get_index()`).
Estimated parameters from the Matérn covariance function can be used to describe the marginal spatial variance and Matérn range (distance at which spatial correlation decays to $\sim$ 0.13).

<!--
Highlights?

- Basic spatial model structure and notation / INLA / SPDE / GMRF defined. Advantages of PC-priors [], though sdmTMB also allows priors on most parameters (e.g. fixed effects, obs error variances)
- Flexible extension of glmmTMB [Brooks et al. 2017] -- and includes non-spatial models for direct comparisons with glmmTMB [@osgood-zimmerman2021]
- Spatiotemporal models (RW/AR v IID)
- Time varying parameters
- Non-linear effects (smooth splines, threshold/breakpoint functions)
- Variance estimation and derived quantities (spatial range, area occupied etc)
-->

# Supporting Information

We use the notation of a bold capital letter to represent a matrix, a bold lowercase greek letter to represent a parameter vector, the index $\bm{s}$ to represent a point in space (x and y and coordinates), and the index $t$ to represent a point in time.
The general form of a GLMM is
$g(\bm{\mu}) = \bm{X \beta} + \bm{Z \psi}$,
with the inverse link function $g(x)$ relating the mean $\bm{\mu}$ to fixed-effect predictors in the design matrix $\bm{X}$ with estimated coefficients $\bm{\beta}$ and random effects with the design matrix $\bm{Z}$ with estimated coefficients $\bm{\psi}$.
<!-- The matrix $\bm{Z}$ allows random effects to be structured (e.g., intercepts varying by group) or unstructured, with $\bm{u}$ representing random variation. -->
For clarity, we partition the random effects $\bm{Z \psi}$ into a number of more interpretable components, each of which can optionally be included in the model. Though in practice it is rare to include all of these parameters, the full `sdmTMB` model is
$$
g(\mu_{\bm{s},t}) =
\bm{X}_{1,\bm{s},t} \bm{\beta} +
\bm{\alpha}_g +
\bm{X}_{2,\bm{s},t} \gamma_t +
\bm{X}_{3,t} \zeta_{\bm{s}} +
\omega_{\bm{s}} +
\epsilon_{\bm{s},t},
$$
where

* $\bm{X}_{1,\bm{s},t}$, $\bm{X}_{2,\bm{s},t}$, and $\bm{X}_{3,\bm{s},t}$ represent design matrices;
* $\bm{\beta}$ represents a vector of fixed-effect coefficients;
* $\alpha_{g}$ represents random intercepts by group $g$, $\alpha_{g}\sim \mathrm{N}(0,\sigma^2_\alpha)$;
* $\gamma_{t}$ represents time-varying coefficients (a random walk), $\gamma_{t} \sim \mathrm{N}(\gamma_{t-1},\sigma^2_\gamma)$;
* $\zeta_{\bm{s}}$ represents spatially varying coefficients (a random field), $\zeta_{\bm{s}} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_\zeta)$;
* $\omega_{\bm{s}}$ represents a random spatial component (a random field), $\omega_{\bm{s}} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_\omega)$; and
* $\epsilon_{\bm{s},t}$ represents a spatiotemporal component (a random field), $\epsilon_{\bm{s},t} \sim \mathrm{MVN}(\bm{0},\bm{\Sigma}_{\epsilon})$.

The random fields are constructed as Gaussian Markov random fields (GMRF), where the random effects are structured as MVN constrained by a \mbox{Mat\'ern} covariance function. Additional details are provided in the SI.


# Application Examples


```{r libs, echo = TRUE}
library(sdmTMB)
library(ggplot2)
```

```{r}
theme_set(ggsidekick::theme_sleek())
```

First, we construct a mesh to approximate the spatial process, which is used in the SPDE calculations. The `make_mesh()` function accepts the data coordinates and the minimum allowed distance between v vertices (`cutoff`) or approximate number of knots in the mesh (`n_knots`).
Custom built meshes with `INLA` (including meshes with barriers limiting covariance across polygons) can also be passed in (examples included in `?make_mesh`).
For example, an mesh with a cutoff distance of 10km can be made with

```{r mesh, echo = TRUE, cache=FALSE}
mesh <- make_mesh(pcod_2011, xy_cols = c("X", "Y"), cutoff = 10)
```

```{r plot-mesh, echo = TRUE, fig.height=5, fig.width=5, out.width="3.25in"}
plot(mesh)
```

```{r fit-pcod, cache=TRUE, echo = TRUE}
fit <- sdmTMB(density ~ 0 + as.factor(year) + s(depth), data = pcod_2011,
 time = "year", spde = mesh, family = tweedie(link = "log")
)
```

```{r print-fit, echo = TRUE, cache=TRUE}
print(fit)
```


```{r tidy, eval=TRUE, echo=TRUE}
tidy(fit, conf.int = TRUE)
```

```{r, eval=TRUE, echo=TRUE}
tidy(fit, effects = "ran_pars", conf.int = TRUE)
```

```{r predict, cache=TRUE, echo = TRUE}
pred <- predict(fit)
```

```{r qqnorm, cache=TRUE, fig.width=4, fig.height=4, out.width="3.5in", echo = TRUE}
pred$resid <- residuals(fit)
# qqnorm(pred$resid);qqline(pred$resid) # not shown for space
```

```{r plot-resids, echo = FALSE, eval=FALSE}
ggplot(subset(pred, year == 2017), aes(X, Y, colour = resid)) +
    geom_point() + facet_wrap(~year) +
    coord_fixed() + scale_colour_gradient2()
```

```{r predict-newdata, cache=TRUE, echo = TRUE}
qcs_grid_2011 <- subset(qcs_grid, year >= 2011)
pred_qcs <- predict(fit, newdata = qcs_grid_2011)
```

```{r plot-predictions, echo = TRUE, fig.height=5, fig.width=5, out.width="4.5in", cache=TRUE}
ggplot(pred_qcs, aes(X, Y, fill = exp(est))) +
    geom_raster() + facet_wrap(~year) +
    coord_fixed() + scale_fill_viridis_c(trans = "sqrt")
```

```{r marginal, cache=TRUE, echo = TRUE, fig.height=2.5, fig.width=4, out.width="3.5in", echo = TRUE}
nd <- data.frame(depth = seq(50, 300, length.out = 100), year = 2017L)
pred_depth <- predict(fit, newdata = nd, se_fit = TRUE, re_form = ~ 0)
ggplot(pred_depth, aes(depth, exp(est),
  ymin = exp(est - 1.96 * est_se), ymax = exp(est + 1.96 * est_se))) +
  geom_line() + geom_ribbon(alpha = 0.4) +
  ylab("Expected density\n(kg/TODO)") +
  xlab("Depth (m)")
```

```{r sims, cache=TRUE, echo=TRUE}
pred_sims <- predict(fit, newdata = qcs_grid_2011, sims = 500)
dim(pred_sims)
```

```{r sims-cv-plot, cache=TRUE, fig.height=4, fig.width=4, out.width="3.5in", echo=TRUE}
qcs_grid_2011$cv <- apply(pred_sims, 1, function(x) sd(exp(x)) / mean(exp(x)))
ggplot(subset(qcs_grid_2011, year == 2011), aes(X, Y, fill = cv)) +
    geom_raster() + facet_wrap(~year) +
    coord_fixed() + scale_fill_viridis_c(trans = "log10")
```

```{r index, cache=TRUE, fig.height=2.5, fig.width=4, out.width="3.5in"}
qcs_grid_2011$area <- 4 # all 2 x 2km
pred2 <- predict(fit, newdata = qcs_grid_2011, return_tmb_object = TRUE,
  area = qcs_grid_2011$area)
ind <- get_index(pred2)
ggplot(ind, aes(year, est)) + geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4) +
  ylab("Biomass (kg)")
```

# Implementation and Availability

- CRAN before?
-
# Performance

- Probably some discussion of speed. Comparison of one of the models in the application above to INLA? Or other software, e.g. Stan -- though that's not as fair :). [EW: at least for the rainfall example I found inlabru to be about twice as fast as sdmTMB]
- Probably not extensive space for simulation testing, but could do some minimal example and point to vignettes

# Discussion

# Conclusion

Optional

# Acknowledgements

# Conflict of Interest statement

# Author Contributions

<!--
All submissions with more than one author must include an Authors’ contributions statement. All persons listed as authors on a paper are expected to meet ALL of the following criteria for authorship:

substantial contributions to conception and design, or acquisition of data, or analysis and interpretation of data, or drafting the article or revising it critically for important intellectual content;
final approval of the version to be published;
agreement to be accountable for the aspects of the work that they conducted and ensuring that questions related to the accuracy or integrity of any part of their work are appropriately investigated and resolved.
Acquisition of funding, provision of facilities, or supervising the research group of authors without additional contribution are not usually sufficient justifications for authorship. The statement should include an explanation of the contribution of each author. We suggest the following format for the Authors’ contributions statement:

AB and CD conceived the ideas and designed methodology; CD and EF collected the data; EF and GH analysed the data; AB and CD led the writing of the manuscript. All authors contributed critically to the drafts and gave final approval for publication. -->


# Data Availability

<!--
To enable readers to locate archived data from papers, we require that authors list the database and the respective accession numbers or DOIs for all data from the manuscript that has been made publicly available. For example, “Data available from the Dryad Digital Repository http://dx.doi.org/10.5061/dryad.41qh7 (Kiere & Drummond 2016).” When a DOI is available for the data, the full data citation should also be given in the reference list (see below). For further information see our data archiving policy.
-->

# Tables

1. Comparison to related software?

- VAST
- INLA
- mgcv
- glmmTMB
- glmmfields?
- other stuff on CRAN, spBayes etc.

# Figures

1. Flow diagram of functions? Not needed?
1. Speed with various knots and/or spatial complexity in comparison to INLA + VAST + ...?
1. Example application 1 - SDM, show mesh(?) and/or raw data, show predictions and SD in space,
1. Example application 2 - population index with stitched survey?

Content:

-   outline the general need for this type of modelling

-   outline the need for this type of package to make the models accessible and rapid to iterate on

-   emphasize the niche carved out: a fast, flexible, easy-to-use, predictive-process univariate spatial or spatiotemporal GLMM, scales from maximum likelihood to penalized likelihood to full Bayesian inference

-   outline the philosophy and how the functions work together

    -   modular
    -   familiar (similar to glm, lme4, glmmTMB, mgcv, etc.)
    -   separate fitting and predicting
    -   avoid expensive calculations unless needed

-   table comparison to related packages

-   case studies

    -   an SDM with time-varying depth?
    -   an index calculation?
    -   stitching surveys?

-   how it achieves the steps Jim described [@thorson2019] in what a VAST-related package has to be able to do (and how VAST does it vs. how sdmTMB does it)
    -   "VAST represents four main design principles. Although there are many other implementation details that distinguish VAST from previous index-standardization methods, I believe that these four design principles represent the features that any future replacement should include."
    -   Area weighting (check, helper functions to sum up weighted grid cells)
    -   Distinct catchability and habitat covariates (check, decide what goes into `predict()`)
    -   Condition on missing covariates (check, random fields)
    -   Bridge between univariate and multivariate applications (no! should we?)

-   speed comparisons (INLA [inlabru?], VAST, mgcv, glmmTMB without predictive process?)

-   intended audience: ecology, but much broader too

-   self simulation testing --- appendix

-   package comparison fitting --- appendix

\clearpage

# References

::: {#refs}
:::

```{=tex}
\clearpage
\beginsupplement
```

# Supplemental Materials

### Matern parameterization
<!-- EW: Because of space limits, I might suggest moving all this to the SI -->
The \mbox{Mat\'ern} defines the covariance $\Phi \left( s_j, s_k \right)$ between spatial locations $s_j$ and $s_k$ as $\Phi\left( s_j,s_k \right) = \tau^2/\Gamma(\nu)2^{\nu - 1}
(\kappa d_{jk})^\nu K_\nu \left( \kappa d_{jk} \right)$,
<!-- TODO: paraphrase this to avoid self plagiarizing the synopsis report! -->
where $\tau^2$ represents the spatial variance, $\Gamma$ represents the Gamma function, $K_\nu$ represents the Bessel function, $d_{jk}$ represents the Euclidean distance between locations $s_j$ and $s_k$, and $\kappa$ represents
a scaling parameter that is estimated (REF).
The parameter $\nu$ controls the smoothness of the covariance function.
We set $\nu = 1$, which lets us take advantage of the Stochastic Partial Differential Equation (SPDE) approximation to the GMRF to greatly increase computational efficiency [@lindgren2011].



### Junk to delete
*EW: These are just placeholders -- not sure what order is best or what to highlight in very limited space*

As a first example, we use a spatial dataset (`parana`) from the `geoR` package (Ribeiro Jr and Diggle 2018) that describes average May-June rainfall recorded at 143 stations in the state of Paraná, Brazil. This dataset is also well-known because it is used as an example of spatiotemporal modeling with INLA (cite INLA) book. Because the dataset doesn't include covariates and only includes a single year, we can model rainfall using an intercept and spatial component, $g(\mu_{s,t}) = b_{0} + \omega_{s}$. We assume the observation model for the rainfall data is normally distributed. The first step in fitting a model with `sdmTMB` is constructing the mesh to approximate the spatial process. This step can be done with the `make_mesh` function, which accepts the data (coordinates) and at minimum, the minimum allowed distance between points (`cutoff`) or approximate number of knots in the mesh (`n_knots`). Custom built meshes with INLA can also be passed in (additional examples of this are included in the SI). For example, an initial mesh with a cutoff distance of 0.1km could be made with

```{r eval=FALSE, echo=TRUE}
rain_spde = make_mesh(data = parana, c("east","north"), cutoff=0.1)
```

Second, we can fit the model using TMB with the `sdmTMB` function, whose formula syntax should be familiar to most R users,

```{r eval = FALSE, echo=TRUE}
fit = sdmTMB(data ~ 1, data=parana, spde = rain_spde)
```

As a second example, we use `sdmTMB` to analyze a 2-year dataset of Eurasian cranes (*Grus grus*) from England, UK (Soriano-Redondo et al. 2019). In the original analysis, Soriano-Redondo et al. 2019 used log Gaussian Cox process models to jointly model crane presence--absence and the spatiotemporal distribution of wetlands. We use this dataset as an example of modeling presence--absence data with sdmTMB, and only model the occurence of cranes given covariates. With any multi-year dataset, a common question of interest is often whether observations can be best described by spatial variation, or spatial and spatiotemporal variation. With two years of data, we fit two models with `sdmTMB`: a model with a spatial component but no spatiotemporal variation, and a model with only spatiotemporal variation (allowing each year to have a different spatial field). We included the same fixed effect covariates in both models: different intercepts by year, and two covariates found to be important by Soriano-Redondo et al. 2019 (wetland area, perimeter to area ratio). As a coarse comparison of data support, we compare the Akaike's Information Criterion (Akaike 1973) from each model. The model with a shared spatial field appeared to be more supported ($\Delta AIC$=25.23). The sdmTMB package allows for additional model comparisons, including k-fold cross validation with the `sdmTMB_cv` function.

Third more detailed example -- something like `pcod` or a fisheries dataset, with the Tweedie distribution, use of predict() function, and creating indices of abundance?
